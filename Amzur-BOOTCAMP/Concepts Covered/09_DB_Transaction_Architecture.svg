<svg viewBox="0 0 1400 1100" xmlns="http://www.w3.org/2000/svg">
  <!-- Background -->
  <rect width="1400" height="1100" fill="#f8fafc"/>
  
  <!-- Title -->
  <text x="700" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="#1e293b">
    Complete Database Transaction Management Architecture
  </text>
  <text x="700" y="55" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" fill="#64748b">
    FastAPI + SQLAlchemy + PostgreSQL with Threading &amp; Multi-Transaction Sessions
  </text>
  
  <!-- Request Layer -->
  <rect x="50" y="90" width="1300" height="120" fill="#e2e8f0" rx="10" stroke="#94a3b8" stroke-width="2"/>
  <text x="700" y="115" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#334155">
    Concurrent Request Handling Layer
  </text>
  
  <!-- Multiple Client Requests -->
  <rect x="80" y="130" width="120" height="60" fill="#3b82f6" rx="8"/>
  <text x="140" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">Request 1</text>
  <text x="140" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Create User</text>
  <text x="140" y="180" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Thread ID: 1</text>
  
  <rect x="220" y="130" width="120" height="60" fill="#3b82f6" rx="8"/>
  <text x="280" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">Request 2</text>
  <text x="280" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Update Order</text>
  <text x="280" y="180" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Thread ID: 2</text>
  
  <rect x="360" y="130" width="120" height="60" fill="#3b82f6" rx="8"/>
  <text x="420" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">Request 3</text>
  <text x="420" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Delete Product</text>
  <text x="420" y="180" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Thread ID: 3</text>
  
  <!-- FastAPI Thread Pool -->
  <rect x="550" y="130" width="180" height="60" fill="#10b981" rx="8"/>
  <text x="640" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">FastAPI Thread Pool</text>
  <text x="640" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">Uvicorn Workers</text>
  <text x="640" y="180" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">Async Event Loop</text>
  
  <!-- Connection Pool -->
  <rect x="780" y="130" width="180" height="60" fill="#f59e0b" rx="8"/>
  <text x="870" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">Connection Pool</text>
  <text x="870" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">Max: 20 connections</text>
  <text x="870" y="180" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">Available: 17</text>
  
  <!-- Database -->
  <rect x="1020" y="130" width="150" height="60" fill="#6366f1" rx="8"/>
  <text x="1095" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="white">PostgreSQL</text>
  <text x="1095" y="165" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">Database Server</text>
  <text x="1095" y="180" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="white">ACID Compliant</text>
  
  <!-- Thread to Session Mapping -->
  <rect x="100" y="250" width="1200" height="200" fill="#f1f5f9" rx="10" stroke="#475569" stroke-width="2"/>
  <text x="700" y="275" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#1e293b">
    Thread-to-Session Isolation (Session Per Request Pattern)
  </text>
  
  <!-- Thread 1 Session -->
  <rect x="130" y="295" width="350" height="140" fill="#ddd6fe" rx="8" stroke="#8b5cf6" stroke-width="2"/>
  <text x="305" y="315" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#6b21a8">
    Thread 1 â†’ Session A
  </text>
  
  <rect x="150" y="330" width="100" height="40" fill="#8b5cf6" rx="5"/>
  <text x="200" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="white">Transaction 1</text>
  <text x="200" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">BEGIN</text>
  
  <rect x="270" y="330" width="100" height="40" fill="#a855f7" rx="5"/>
  <text x="320" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="white">Transaction 2</text>
  <text x="320" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">COMMIT</text>
  
  <rect x="390" y="330" width="100" height="40" fill="#c084fc" rx="5"/>
  <text x="440" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="white">Transaction 3</text>
  <text x="440" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">ROLLBACK</text>
  
  <text x="305" y="390" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#6b21a8">
    Identity Map: {user_1: &lt;User id=1&gt;, order_2: &lt;Order id=5&gt;}
  </text>
  <text x="305" y="405" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#6b21a8">
    Connection: Pool[0] â†’ PostgreSQL Connection #1
  </text>
  <text x="305" y="420" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#6b21a8">
    Session State: Active | Autocommit: False
  </text>
  
  <!-- Thread 2 Session -->
  <rect x="525" y="295" width="350" height="140" fill="#fef3c7" rx="8" stroke="#f59e0b" stroke-width="2"/>
  <text x="700" y="315" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#92400e">
    Thread 2 â†’ Session B
  </text>
  
  <rect x="545" y="330" width="100" height="40" fill="#f59e0b" rx="5"/>
  <text x="595" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="white">Transaction 1</text>
  <text x="595" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">ACTIVE</text>
  
  <rect x="665" y="330" width="100" height="40" fill="#fbbf24" rx="5"/>
  <text x="715" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="white">Transaction 2</text>
  <text x="715" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">PENDING</text>
  
  <rect x="785" y="330" width="70" height="40" fill="#d1d5db" rx="5"/>
  <text x="820" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#6b7280">Savepoint</text>
  <text x="820" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#6b7280">sp_1</text>
  
  <text x="700" y="390" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    Identity Map: {order_5: &lt;Order id=5&gt;, product_3: &lt;Product id=3&gt;}
  </text>
  <text x="700" y="405" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    Connection: Pool[1] â†’ PostgreSQL Connection #2
  </text>
  <text x="700" y="420" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#92400e">
    Session State: Active | Nested Transaction Support
  </text>
  
  <!-- Thread 3 Session -->
  <rect x="920" y="295" width="350" height="140" fill="#fee2e2" rx="8" stroke="#ef4444" stroke-width="2"/>
  <text x="1095" y="315" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#dc2626">
    Thread 3 â†’ Session C
  </text>
  
  <rect x="940" y="330" width="100" height="40" fill="#ef4444" rx="5"/>
  <text x="990" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="white">Transaction 1</text>
  <text x="990" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">FAILED</text>
  
  <rect x="1060" y="330" width="100" height="40" fill="#fca5a5" rx="5"/>
  <text x="1110" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="white">Rollback</text>
  <text x="1110" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">EXECUTED</text>
  
  <rect x="1180" y="330" width="70" height="40" fill="#d1d5db" rx="5"/>
  <text x="1215" y="345" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" font-weight="bold" fill="#6b7280">Cleanup</text>
  <text x="1215" y="358" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="#6b7280">DONE</text>
  
  <text x="1095" y="390" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#dc2626">
    Identity Map: {} (cleared after rollback)
  </text>
  <text x="1095" y="405" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#dc2626">
    Connection: Pool[2] â†’ PostgreSQL Connection #3
  </text>
  <text x="1095" y="420" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#dc2626">
    Session State: Closed | Exception Handled
  </text>
  
  <!-- Transaction Lifecycle Detail -->
  <rect x="100" y="480" width="1200" height="280" fill="#f8fafc" rx="10" stroke="#475569" stroke-width="2"/>
  <text x="700" y="505" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#1e293b">
    Multi-Transaction Session Lifecycle with Rollback Mechanisms
  </text>
  
  <!-- Transaction States -->
  <rect x="130" y="530" width="140" height="100" fill="#22c55e" rx="8"/>
  <text x="200" y="550" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">1. Session Start</text>
  <text x="200" y="570" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">db = SessionLocal()</text>
  <text x="200" y="585" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Connection acquired</text>
  <text x="200" y="600" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Thread-local storage</text>
  <text x="200" y="615" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Identity Map init</text>
  
  <rect x="290" y="530" width="140" height="100" fill="#3b82f6" rx="8"/>
  <text x="360" y="550" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">2. Transaction 1</text>
  <text x="360" y="570" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">BEGIN</text>
  <text x="360" y="585" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">db.add(user)</text>
  <text x="360" y="600" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">db.commit()</text>
  <text x="360" y="615" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">SUCCESS âœ“</text>
  
  <rect x="450" y="530" width="140" height="100" fill="#f59e0b" rx="8"/>
  <text x="520" y="550" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">3. Transaction 2</text>
  <text x="520" y="570" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">BEGIN (auto)</text>
  <text x="520" y="585" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">db.add(order)</text>
  <text x="520" y="600" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">db.flush()</text>
  <text x="520" y="615" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Get ID, keep open</text>
  
  <rect x="610" y="530" width="140" height="100" fill="#8b5cf6" rx="8"/>
  <text x="680" y="550" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">4. Nested Logic</text>
  <text x="680" y="570" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">with db.begin():</text>
  <text x="680" y="585" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">  savepoint created</text>
  <text x="680" y="600" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">  nested operations</text>
  <text x="680" y="615" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">  auto-rollback</text>
  
  <!-- Rollback Scenarios -->
  <rect x="770" y="530" width="140" height="100" fill="#ef4444" rx="8"/>
  <text x="840" y="545" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="white">5A. Exception</text>
  <text x="840" y="560" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">try:</text>
  <text x="840" y="575" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">  db.commit()</text>
  <text x="840" y="590" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">except:</text>
  <text x="840" y="605" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">  db.rollback()</text>
  <text x="840" y="620" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">  raise</text>
  
  <rect x="930" y="530" width="140" height="100" fill="#10b981" rx="8"/>
  <text x="1000" y="545" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="white">5B. Success</text>
  <text x="1000" y="560" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">db.commit()</text>
  <text x="1000" y="575" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">All changes</text>
  <text x="1000" y="590" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">persisted</text>
  <text x="1000" y="605" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">Transaction ends</text>
  <text x="1000" y="620" text-anchor="middle" font-family="Arial, sans-serif" font-size="8" fill="white">ACID âœ“</text>
  
  <rect x="1090" y="530" width="140" height="100" fill="#64748b" rx="8"/>
  <text x="1160" y="550" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="white">6. Cleanup</text>
  <text x="1160" y="570" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">db.close()</text>
  <text x="1160" y="585" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Connection â†’ Pool</text>
  <text x="1160" y="600" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Identity Map clear</text>
  <text x="1160" y="615" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="white">Thread-local clean</text>
  
  <!-- Rollback Types -->
  <rect x="150" y="650" width="1100" height="90" fill="#fef2f2" rx="8" stroke="#ef4444" stroke-width="2"/>
  <text x="700" y="675" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#dc2626">
    Rollback Mechanisms &amp; Transaction Isolation
  </text>
  
  <text x="180" y="700" font-family="Arial, sans-serif" font-size="11" fill="#dc2626">
    <tspan font-weight="bold">Full Rollback:</tspan> db.rollback() - Undoes ALL changes in current transaction, returns to last COMMIT
  </text>
  <text x="180" y="718" font-family="Arial, sans-serif" font-size="11" fill="#dc2626">
    <tspan font-weight="bold">Savepoint Rollback:</tspan> Nested transactions with savepoints - Partial rollback to specific checkpoint
  </text>
  <text x="180" y="736" font-family="Arial, sans-serif" font-size="11" fill="#dc2626">
    <tspan font-weight="bold">Thread Isolation:</tspan> Each thread has its own session - Changes invisible to other threads until COMMIT
  </text>
  
  <!-- Key Concepts -->
  <rect x="150" y="780" width="1100" height="110" fill="#f0fdf4" rx="8" stroke="#22c55e" stroke-width="2"/>
  <text x="700" y="805" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#15803d">
    Advanced Concepts Explained
  </text>
  
  <text x="180" y="830" font-family="Arial, sans-serif" font-size="11" fill="#15803d">
    <tspan font-weight="bold">Session Per Request:</tspan> FastAPI dependency injection ensures each HTTP request gets isolated session
  </text>
  <text x="180" y="848" font-family="Arial, sans-serif" font-size="11" fill="#15803d">
    <tspan font-weight="bold">Multi-Transaction Sessions:</tspan> One session can handle multiple BEGIN/COMMIT cycles for complex operations
  </text>
  <text x="180" y="866" font-family="Arial, sans-serif" font-size="11" fill="#15803d">
    <tspan font-weight="bold">Identity Map Persistence:</tspan> Objects cached in session survive individual transaction boundaries
  </text>
  <text x="180" y="884" font-family="Arial, sans-serif" font-size="11" fill="#15803d">
    <tspan font-weight="bold">Connection Lifecycle:</tspan> Physical DB connection acquired once, reused across multiple transactions in same session
  </text>
  
  <!-- Connection arrows -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
    </marker>
    <marker id="errorArrow" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
    </marker>
  </defs>
  
  <!-- Request flow arrows -->
  <path d="M 200 160 L 540 160" stroke="#374151" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 730 160 L 770 160" stroke="#374151" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 960 160 L 1010 160" stroke="#374151" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Thread to session mapping -->
  <path d="M 140 210 L 200 285" stroke="#8b5cf6" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 280 210 L 580 285" stroke="#f59e0b" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 420 210 L 1020 285" stroke="#ef4444" stroke-width="3" fill="none" marker-end="url(#arrowhead)" stroke-dasharray="5,5"/>
  
  <!-- Transaction flow -->
  <path d="M 270 575 L 280 575" stroke="#374151" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 430 575 L 440 575" stroke="#374151" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 590 575 L 600 575" stroke="#374151" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Success/Error paths -->
  <path d="M 750 575 L 920 575" stroke="#22c55e" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <path d="M 750 555 L 920 555" stroke="#ef4444" stroke-width="2" fill="none" marker-end="url(#errorArrow)" stroke-dasharray="5,5"/>
  
  <!-- Cleanup -->
  <path d="M 1070 575 L 1080 575" stroke="#374151" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  
  <!-- Pool visualization -->
  <circle cx="1200" cy="950" r="40" fill="#ddd6fe" stroke="#8b5cf6" stroke-width="2"/>
  <text x="1200" y="955" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Pool</text>
  <circle cx="1180" cy="980" r="8" fill="#22c55e"/>
  <circle cx="1200" cy="980" r="8" fill="#ef4444"/>
  <circle cx="1220" cy="980" r="8" fill="#ef4444"/>
  <text x="1200" y="1010" text-anchor="middle" font-family="Arial, sans-serif" font-size="8">ðŸŸ¢ Free ðŸ”´ Busy</text>
  
</svg>